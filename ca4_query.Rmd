---
title: "2022 - Data Analytics for Immersive Environments - CA4 - RDBMS & Linear Regression Project"
subtitle: "CA4 Part 2 - Querying Database"
author: "Joe O'Regan"
date: "2023-01-11"
output: html_document
---

<!-- clear console -->
```{r setup, include=FALSE}
cat('\014')
#knitr::opts_chunk$set(echo = TRUE)
```

---

## ER Diagram

![Entity Relationship Diagram](daie_ca4_er_diagram.png)

---

## Make Database Connection

```{r setup libraries, include=FALSE}
# libraries to query database
if(!require("DBI"))
  install.packages("DBI")
if(!require("dplyr"))
  install.packages("dplyr")
library(DBI)
library(dplyr)
```

Connect to the sqlite database file.

```{r connect to the sqlite database file}
# connect to the sqlite database file
conn <- dbConnect(RSQLite::SQLite(), "daie_ca4_data.sqlite")
```

---

## TABLE CONTENTS

Contents of tables to check queries against.

### Status

Get all rows in Status table.

```{sql connection=conn, output.var="status_data"}
SELECT * FROM Status
```

Display table using knitr library kable function.

```{r output status table contents}
knitr::kable(status_data)
```

---

### Role

Get all rows in Role table.

```{sql connection=conn, output.var="role_data"}
SELECT * FROM Role
```

Display Role table data.

```{r output role table contents}
role_data
```

---

### Team_Member

Get all rows in Team_Member table.

```{sql connection=conn, output.var="team_member_data"}
SELECT * FROM Team_Member
```

Display Team_Member table data.

```{r output team_member table contents}
team_member_data
```

---

### Work_Item

Get all rows in Work_Item table.

```{sql connection=conn, output.var="work_item_data"}
SELECT * FROM Work_Item
```

Display Work_Item table data.

```{r output work_item table contents}
work_item_data
```

---

### Project

Get all rows in Project table.

```{sql connection=conn, output.var="project_data"}
SELECT * FROM Project
```

Display Project table data.

```{r output project table contents}
project_data
```

---

### Project_Team

Get all rows in Project_Team table.

```{sql connection=conn, output.var="project_team_data"}
SELECT * FROM Project_Team
```

Display Project_Team table data.

```{r output project_team table contents}
project_team_data
```

---

### Asset

Get all rows in Asset table.

```{sql connection=conn, output.var="asset_data"}
SELECT * FROM Asset
```

Display Asset table data.

```{r output asset table contents}
asset_data
```

---

### Asset_Work_Items

Get all rows in Asset_Work_Items table.

```{sql connection=conn, output.var="asset_work_items_data"}
SELECT * FROM Asset_Work_Items
```

Display Asset_Work_Items table data.

```{r output asset_work_items table contents}
asset_work_items_data
```

---

### Library

Get all rows in Library table.

```{sql connection=conn, output.var="library_data"}
SELECT * FROM Library
```

Display Library table data.

```{r output library table contents}
library_data
```

---

### Collection

Get all rows in Collection table.

```{sql connection=conn, output.var="collection_data"}
SELECT * FROM Collection
```

Display Collection table data.

```{r output collection table contents}
collection_data
```

---

## **Database Querying**

1. SELECT with WHERE, LIKE, and OR
2. SELECT with DISTINCT and ORDER BY
3. Inner Join
4. Subquery with SELECT
5. SELECT across a date range

### **1. SELECT with WHERE, LIKE, and OR**

#### **Select with WHERE**

Find Team Members who have the first name Joe.

```{sql connection=conn, output.var="query1_select_with_where"}
SELECT * FROM Team_Member WHERE First_Name = 'Joe';

```

```{r select with where}
query1_select_with_where
```

---

#### **SELECT with LIKE**

Find Team Members with last name containing the string "derp"

```{sql connection=conn, output.var="query2_select_with_like"}
SELECT * FROM Team_Member WHERE Last_Name LIKE "%derp%";
```

```{r select with like}
query2_select_with_like
```

---

#### **SELECT with OR.**

```{sql connection=conn, output.var="query3_select_with_or"}
SELECT * FROM Team_Member WHERE Role_Id = 2 OR Role_Id = 7;
```

```{r select with or}
query3_select_with_or
```

---

#### **SELECT with WHERE, LIKE and OR**

Find work items with Name beginning with a string like "art" or have a Status_Id of 3.

```{sql connection=conn, output.var="query4_select_with_where_like_or"}
SELECT * FROM Work_Item WHERE Name LIKE "art%" OR Status_Id = 3;
```

```{r select with where like or}
query4_select_with_where_like_or
```

---

### **2. SELECT with DISTINCT and ORDER BY**

#### **SELECT with DISTINCT**

Find the unique status IDs currently in the Work_Item table.

```{sql connection=conn, output.var="query5_select_distinct"}
SELECT DISTINCT Status_Id FROM Work_Item;
```

```{r select distinct}
query5_select_distinct
```

---

#### **SELECT with ORDER BY**

Display work items ordered by assigned_to (Team_Member.Id).

```{sql connection=conn, output.var="query6_select_order_by"}
SELECT * FROM Work_Item ORDER BY Assigned_To;
```

```{r select order by}
query6_select_order_by
```

---

#### **SELECT with ORDER BY ASC**

Display work items ordered by Status_Id (Status.Id) in ascending order.

```{sql connection=conn, output.var="query7_select_order_by_asc"}
SELECT * FROM Work_Item ORDER BY Status_Id ASC;
```

```{r select order by asc}
query7_select_order_by_asc
```

---

#### **SELECT with ORDER BY DESC**

Display work items ordered by Assigned_To (Team_Member.Id) in descending order.

```{sql connection=conn, output.var="query8_select_order_by_desc"}
SELECT * FROM Work_Item ORDER BY Assigned_To DESC;
```

```{r select order by desc}
query8_select_order_by_desc
```

---

#### **SELECT with DISTINCT and ORDER By**

Display work items ordered by Assigned_To (Team_Member.Id) in descending order.

```{sql connection=conn, output.var="query9_select_distinct_order_by"}
SELECT DISTINCT Assigned_To FROM Work_Item ORDER BY Assigned_To;
```

```{r select with distinct and order by}
query9_select_distinct_order_by
```

---

### **3. Inner Join**

Inner Join Team_Member and Role tables via foreign key Team_Member.Role_id corresponding to Role.Id. 

First name and last name are concatenated with the || operator as Concat() doesn't work in Sqlite. Using Alias (AS) for column headings and t for Team_Member and r for Role table aliases.

```{sql connection=conn, output.var="query10_select_inner_join"}
 -- no Concat() in sqlite, || = concat operator
SELECT t.Id as "Team Member Id", 
t.First_Name || ' ' || t.Last_Name AS 'Full Name',
r.Name AS 'Project Role'
From Team_Member t
Inner Join Role r
ON t.Role_Id = r.Id
```

```{r select with inner join}
query10_select_inner_join
```

---

### Disconnect Database

```{r disconnect from database}
dbDisconnect(conn)
```

